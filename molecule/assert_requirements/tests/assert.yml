---
# yamllint disable rule:line-length
- name: 'Assert failures | converge | {{ test_name }}'
  block:
    - name: 'Assert failures | converge | {{ test_name }} | test setup'
      ansible.builtin.set_fact:
        _test_failed: true

    - name: 'Assert failures | converge | {{ test_name }} | missing assertion'
      ansible.builtin.include_role:
        name: 'r_pufky.srv.repo'

  rescue:
    - name: 'Assert failures | converge | {{ test_name }} | PASS'
      ansible.builtin.set_fact:
        _test_failed: false

    - name: 'Assert failures | converge | {{ test_name }} | PASS'
      ansible.builtin.debug:
        msg: |

          TEST PASSED.

  always:
    - name: 'Assert failures | converge | {{ test_name }} | FAIL'
      when: _test_failed
      ansible.builtin.fail:
        msg: '{{ test_fail_message }}'
